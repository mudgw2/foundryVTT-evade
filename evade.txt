// Ensure the game object is available (it should be in Foundry VTT context)
if (typeof game === 'undefined' || !game.user) {
    console.error("Foundry VTT 'game' object not found or user not logged in. This script must be run within an active Foundry VTT session.");
}else{ 
      if(!canvas.tokens.controlled.length){
        //No token selected, send notice and stop
        ui.notifications.warn("You must have an character selected");
      }else{
        //const actor = canvas.tokens.controlled[0].document;
        const actor = canvas.tokens.controlled[0].actor;
        const target = game.user.targets.values().next().value.actor;

         console.log(actor.name);
         console.log(target.name);

       console.log('Checking for Targets');
    if (game.user.targets.size > 0){
      //const actor = canvas.tokens.controlled[0].actor;
      //This is the characters CL not the Targets...
        const CR = 15 + (1.5*(actor.system.details.cl.value));
        const DC = Math.floor(CR);
        let text = DC;
        const bluff = actor.system.skills?.blu.mod;
        const tokenName = target.name;
        // Log the token name to the console
            ChatMessage.create({
                content: `<small>The ${tokenName} &nbsp;-&nbsp; <strong>Combat Expertise(Ex) Target DC: ${DC}</strong></small>`,
            });
      const diceRoll = new Roll(`1d20`);   
      // Execute the roll
      await diceRoll.evaluate({ async: true });
      const OriginaldiceRoll = diceRoll;
      const ModifieddiceRoll = diceRoll.total + bluff;
      
      if (ModifieddiceRoll >= DC) { 
          // DC Check SUCCESS
          const flatFootedEffectData = {
              label: "flat-footed",
              name: "flat-footed",
              icon: "systems/sfrpg/icons/conditions/flatfooted.webp", // Standard Starfinder flat-footed icon
              origin: game.user.id, // Mark who applied the effect
                  duration: {
                  rounds: 1, // Flat-footed is often for 1 round, but can be adjusted
                  // You can also use `turns`, `combat`, `startRound`, `endRound`, `startTime`, `startTurn`, etc.
                  // For a persistent effect until removed, you might omit duration or set a very long one.
             },
             changes: [
            // This change sets the Dexterity bonus to AC to 0.
            // The 'override' mode (5) means it replaces the existing value.
            // For Starfinder, AC is usually calculated from system.attributes.ac.value
            // and the dexterity bonus is part of that calculation.
            // A more direct way to deny DEX to AC is to set the 'denied' flag or
            // directly modify the AC calculation.
            // The Starfinder system often handles conditions like Flat-Footed
            // by denying the Dexterity bonus to AC directly when the condition is active.
            // We'll add a change that specifically targets the AC calculation.
            // For Starfinder, the 'denied' flag on the AC attribute is the canonical way.
            {
                key: "system.attributes.attack.value", // This key indicates a denied attribute
                mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE, // Override the value
                value: "-2", // Deny the Dexterity bonus
                priority: 20 // High priority to ensure it applies
            },
            // You might also add a direct AC modifier if the above doesn't fully work
            // or if you want to ensure a -2 penalty as a common house rule for flat-footed.
            // {
            //     key: "system.attributes.ac.value",
            //     mode: CONST.ACTIVE_EFFECT_MODES.ADD, // Add a value
            //     value: "-2", // Apply a -2 penalty to AC
            //     priority: 20
            // }
        ],
        flags: {
            core: {
                statusId: "flat-footed" // A unique ID for the status effect
            }
        }
    };

       // Check if the actor already has the Flat-Footed effect
        if (target.system.conditions['flat-footed']) {
          //Target is already flat-footed  
          ui.notifications.info(`${tokenName} is already Fat-Footed.`);
        }else{
              // Create the active effect on the actor
              //target.system.conditions['flat-footed'] = true;
              //target._source.effects.createEmbeddedDocuments("ActiveEffect", [flatFootedEffectData]);
              //ui.notifications.info(`Applied Flat-Footed to ${actor.name} for 1 round.`);
          
          text =`<p><small><strong>${tokenName} is Flat-Footed: -2 DEX?</strong></p><p>Roll:  <a class="inline-result" style="color:black"><i class="fas fa-dice-d20"></i> ${diceRoll.total} + ${bluff} = ${ModifieddiceRoll}</small></p> <p><strong>PLEASE APPLY FLAT FOOTED TO TARGET</p><p>CONTINUE WITH YOUR STANDARD ACTION</p>`;
       
              ChatMessage.create({
                content: text,
              });
            }          
       	}else{
        // DC CHECK FAIL
        text = `<p><small><strong>${tokenName} Ignores the Bluff attempt.</strong></p><p>Roll:  <a class="inline-result" style="color:black"><i class="fas fa-dice-d20"></i> ${diceRoll.total} + ${bluff} = ${ModifieddiceRoll}</small></p>`;
           ChatMessage.create({
                content: text
            });
        //target.system.conditions['flat-footed'] = false;
        }
    }//targetedTokens.size
}//!actor
//canvas.tokens.releaseAll();
}//object check
